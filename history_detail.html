<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>历史详情</title>
  <!-- KaTeX 公式渲染样式 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsmind/style/jsmind.css" />
  <style>
    /* 页面基础样式 */
    body { font-family: sans-serif; background: #f7f7fa; margin: 0; }
    .container { max-width: 1200px; margin: 40px auto; background: #fff; border-radius: 12px; border: 2px dashed #e2e8f0; padding: 32px; }

    /* 标签栏样式改进 */
    .tabs-container { border-bottom: 2px solid #e2e8f0; margin-bottom: 16px; display: flex; }
    .tab-btn {
      padding: 8px 24px;
      background: transparent;
      margin-right: 4px;
      border-radius: 6px 6px 0 0;
      cursor: pointer;
      font-size: 1rem;
      border: 2px solid transparent;
      border-bottom: none;
      position: relative;
      bottom: -2px;
      transition: all 0.2s ease;
    }
    .tab-btn:hover:not(.active) {
      background: #f1f5f9;
    }
    .tab-btn.active {
      background: #fff;
      color: #2563eb;
      border-color: #e2e8f0;
      border-bottom: 2px solid #fff;
      font-weight: 500;
    }

    .tab-content {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      min-height: 300px;
      border: 2px dashed #e2e8f0;
      margin-top: -2px;
    }

    /* 表格样式 */
    .markdown-body table {
      border-collapse: collapse;
      width: 100%;
      margin: 16px 0;
      font-size: 0.95em;
    }
    .markdown-body table th,
    .markdown-body table td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: left;
    }
    .markdown-body table th {
      background-color: #f2f2f2;
      font-weight: 600;
    }
    .markdown-body table tr:nth-child(even) {
      background-color: #f8f8f8;
    }
    .markdown-body table tr:hover {
      background-color: #f1f5f9;
    }

    /* 其他样式保持不变 */
    .compare-flex { display: flex; gap: 2em; }
    .compare-flex > div { flex: 1; min-width: 0; }
    .markdown-body { font-size: 1rem; line-height: 1.7; }
    .markdown-body img {
      max-width: 100%;
      height: auto;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px dashed #e2e8f0;
      display: block;
    }
    pre { background: #f3f3f3; padding: 8px; border-radius: 4px; overflow-x: auto; border: 1px dashed #e2e8f0; }
    h2, h3 { margin-top: 0; }
    .meta { color: #888; font-size: 0.95em; margin-bottom: 1em; }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="fileName">历史详情</h2>
    <div class="meta" id="fileMeta"></div>
    <div class="tabs-container">
      <button class="tab-btn" id="tab-ocr">仅OCR</button>
      <button class="tab-btn" id="tab-translation">仅翻译</button>
      <button class="tab-btn" id="tab-compare">对比</button>
    </div>
    <div class="tab-content" id="tabContent"></div>
  </div>
  <!-- 依赖的JS库 -->
  <script src="js/storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <script src="js/mindmap.js"></script>
  <script src="js/chatbot/chatbot-utils.js"></script>
  <script src="js/chatbot/chatbot-preset.js"></script>
  <script src="js/chatbot/chatbot-core.js"></script>
  <script src="js/chatbot/chatbot-ui.js"></script>
  <script src="js/chatbot/chatbot.js"></script>
  <script>
    // 预处理Markdown，避免非公式 $ 被误判，并处理图片、上标、下标等
    function safeMarkdown(md, images) {
      if (!md) return '';
      // 构建图片名与base64的映射表，支持多种key
      let imgMap = {};
      if (Array.isArray(images)) {
        images.forEach((img, idx) => {
          let keys = [];
          if (img.name) keys.push(img.name);
          if (img.id) keys.push(img.id);
          keys.push(`img-${idx}.jpeg.png`);
          keys.push(`img-${idx+1}.jpeg.png`);
          // 兼容 images/ 前缀
          keys = keys.concat(keys.map(k => 'images/' + k));
          let src = img.data.startsWith('data:') ? img.data : 'data:image/png;base64,' + img.data;
          keys.forEach(k => imgMap[k] = src);
        });
      }
      // 替换Markdown中的本地图片引用为base64
      md = md.replace(/!\[.*?\]\((?:images\/)?(img-\d+\.jpeg\.png)\)/gi, function(_, fname) {
        if (imgMap[fname]) {
          return `![](${imgMap[fname]})`;
        } else {
          return '';
        }
      });
      // 处理上标、下标等自定义语法
      md = md.replace(/\$\{\s*([^}]*)\s*\}\^\{([^}]*)\}\$/g, function(_, base, sup) {
        base = base.trim();
        sup = sup.trim();
        if (base) {
          return `<span>${base}<sup>${sup}</sup></span>`;
        } else {
          return `<sup>${sup}</sup>`;
        }
      });
      md = md.replace(/\$\{\s*([^}]*)\s*\}_\{([^}]*)\}\$/g, function(_, base, sub) {
        base = base.trim();
        sub = sub.trim();
        if (base) {
          return `<span>${base}<sub>${sub}</sub></span>`;
        } else {
          return `<sub>${sub}</sub>`;
        }
      });
      md = md.replace(/\$\{\s*\}\^\{([^}]*)\}\$/g, function(_, sup) {
        return `<sup>${sup.trim()}</sup>`;
      });
      md = md.replace(/\$\{\s*\}_\{([^}]*)\}\$/g, function(_, sub) {
        return `<sub>${sub.trim()}</sub>`;
      });
      md = md.replace(/\$\{\s*([^}]*)\s*\}\$/g, function(_, sup) {
        return `<sup>${sup.trim()}</sup>`;
      });
      // 其余 $...$、$$...$$ 保留，交给 KaTeX 处理
      return md;
    }

    // 使用KaTeX渲染公式，失败时降级为code
    function renderWithKatexFailback(md) {
      // 1. 先把短的 $$...$$ 转为 $...$
      md = md.replace(/\$\$([^\n]+?)\$\$/g, function(_, content) {
        if (content.trim().length <= 10) {
          // 短内容（≤10字符），无论有没有等号，都转为行内公式
          return `$${content}$`;
        } else {
          // 块级公式
          try {
            return katex.renderToString(content, { displayMode: true, throwOnError: true });
          } catch (e) {
            return `<code>$$${content}$$</code>`;
          }
        }
      });
      // 2. 行内公式
      md = md.replace(/\$([^$\n]+?)\$/g, function(_, content) {
        try {
          return katex.renderToString(content, { displayMode: false, throwOnError: true });
        } catch (e) {
          return `<code>$${content}$</code>`;
        }
      });
      // 3. 剩下的块级公式（多行的）
      md = md.replace(/\$\$([\s\S]+?)\$\$/g, function(_, content) {
        try {
          return katex.renderToString(content, { displayMode: true, throwOnError: true });
        } catch (e) {
          return `<code>$$${content}$$</code>`;
        }
      });
      // 4. 其它 markdown
      return marked.parse(md);
    }

    // 获取URL参数
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    let data = null;
    // 渲染历史详情主流程
    async function renderDetail() {
      const id = getQueryParam('id');
      if (!id) return;
      data = await getResultFromDB(id);
      window.data = data;
      if (!data) {
        document.getElementById('fileName').textContent = '未找到数据';
        document.getElementById('fileMeta').textContent = '';
        document.getElementById('tabContent').innerHTML = '';
        return;
      }
      document.getElementById('fileName').textContent = data.name;
      document.getElementById('fileMeta').innerHTML = `时间: ${new Date(data.time).toLocaleString()} &nbsp; | &nbsp; 图片数: ${data.images ? data.images.length : 0}`;
      showTab('ocr');
    }
    // 渲染图片（未直接用到）
    function renderImages(images) {
      if (!images || images.length === 0) return '';
      return images.map(img => {
        let src = img.data.startsWith('data:') ? img.data : 'data:image/png;base64,' + img.data;
        return `<img src="${src}" style="max-width:100%;margin:8px 0;border-radius:6px;box-shadow:0 1px 6px #0002;">`;
      }).join('');
    }
    // 切换tab并渲染内容
    function showTab(tab) {
      document.getElementById('tab-ocr').classList.remove('active');
      document.getElementById('tab-translation').classList.remove('active');
      document.getElementById('tab-compare').classList.remove('active');
      let html = '';
      if(tab === 'ocr') {
        document.getElementById('tab-ocr').classList.add('active');
        html = '<h3>OCR内容</h3><div class="markdown-body" style="background:#fff;padding:16px;border-radius:8px;border:1px solid #e2e8f0;">' + renderWithKatexFailback(safeMarkdown(data.ocr || '', data.images)) + '</div>';
      } else if(tab === 'translation') {
        document.getElementById('tab-translation').classList.add('active');
        html = '<h3>翻译内容</h3>' +
          '<div id="translation-content" class="markdown-body" style="background:#fff;padding:16px;border-radius:8px;border:1px solid #e2e8f0;">' + renderWithKatexFailback(safeMarkdown(data.translation || '', data.images)) + '</div>';
      } else {
        document.getElementById('tab-compare').classList.add('active');
        html = `
          <div class="compare-flex">
            <div><h3>OCR内容</h3><div class="markdown-body" style="background:#fff;padding:16px;border-radius:8px;border:1px solid #e2e8f0;">${renderWithKatexFailback(safeMarkdown(data.ocr || '', data.images))}</div></div>
            <div><h3>翻译内容</h3><div class="markdown-body" style="background:#fff;padding:16px;border-radius:8px;border:1px solid #e2e8f0;">${renderWithKatexFailback(safeMarkdown(data.translation || '', data.images))}</div></div>
          </div>
        `;
      }
      document.getElementById('tabContent').innerHTML = html;
    }
    // 绑定tab按钮点击事件
    document.getElementById('tab-ocr').onclick = function() { showTab('ocr'); };
    document.getElementById('tab-translation').onclick = function() { showTab('translation'); };
    document.getElementById('tab-compare').onclick = function() { showTab('compare'); };
    // 页面加载后渲染详情
    renderDetail();
  </script>
</body>
</html>